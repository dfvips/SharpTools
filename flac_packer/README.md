### FlacPacker
专门用于 FLAC 音乐的封面与歌词无损封装工具，彻底解决乱码与格式问题。

使用 `o3-mini-high` / `gemini-exp-1206` 模型协助生成。

### 开发背景
在使用 FFmpeg 命令行或批处理脚本封装 FLAC 歌词时，经常面临诸多痛点：
1. **中文乱码**：传统的 LRC 文件常为 GBK/GB18030 编码，而现代终端和 FFmpeg 默认为 UTF-8，导致歌词显示为乱码。
2. **格式错误**：简单的命令行参数难以处理歌词中的特殊字符和换行符，导致播放器中歌词变成一行或显示异常。
3. **元数据丢失**：使用 `-map_metadata` 替换歌词时，往往会意外丢失原有的 Title、Artist 等标签信息。
4. **垃圾文件**：批处理通常需要生成临时的 `metadata.txt`，容易污染音乐目录。

### 核心原理
本工具通过 **内存管道流 (Pipe) + 智能编码探测** 的方式工作：

- **智能编码纠错**：采用“黑钻检测法”，优先尝试 UTF-8，若发现乱码特征自动回退至 GB18030/GBK，确保古早 LRC 文件也能完美读取。
- **内存直通管道**：利用 FFmpeg 的 `pipe:0` 标准输入接口，将处理好的元数据直接注入进程，**全程不在硬盘生成任何临时文件**。
- **严格 FFMetadata 规范**：在内存中重组元数据，严格遵循 FFmpeg 规范对换行符（`\` + `\n`）和特殊字符进行转义，确保歌词换行正确。
- **无损标签合并**：先导出原音频标签，在内存中与新歌词合并后再写入，确保原有的专辑、艺术家等信息不丢失。

### 功能
- **拖拽操作**：支持将单个或多个 `.flac` 文件直接拖入程序图标。
- **自动搜寻**：自动在同级目录下寻找同名的 `.jpg/.png` 封面和 `.lrc` 歌词。
- **零临时文件**：保持文件夹整洁，不产生垃圾。
- **完美防乱码**：自动兼容 UTF-8 和 GBK/GB18030 编码的歌词文件。
- **自动寻址**：优先使用同目录下的 `ffmpeg.exe`，若无则调用系统环境变量。

### 环境要求
- Windows 操作系统
- [FFmpeg](https://ffmpeg.org/download.html) (需放在同目录或配置在 Path 环境变量中)

### 使用方法

#### 1. 目录结构准备
请确保你的音乐文件夹结构如下（文件名需保持一致）：
```text
MyMusic/
├── 蒋雪儿 - 落了白.flac
├── 蒋雪儿 - 落了白.jpg  (或 .png)
├── 蒋雪儿 - 落了白.lrc  (可选)
└── flac_packer.exe      (及 ffmpeg.exe)
```

#### 2. 执行封装
选中一个或多个 `.flac` 文件，**直接拖拽** 到 `flac_packer.exe` 图标上即可。

程序将自动生成 `_with_cover.flac` 后缀的新文件。

#### 3. 命令行模式 (可选)
你也可以在终端中调用：
```bat
flac_packer.exe "D:\Music\Song1.flac" "D:\Music\Song2.flac"
```

### 效果演示
**处理前**：
> ❌ 歌词乱码 `˰`
> ❌ 歌词显示为单行，无换行
> ❌ 原有的专辑信息丢失

**处理后**：
> ✅ 歌词中文显示正常
> ✅ 完美支持多行滚动显示
> ✅ 封面已嵌入，且保留原文件所有标签
